variables:
  ssh_file: '~/.ssh/gh_deploy_key.priv'
  isMaster: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]
  isDevelop: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]
  isEpic: $[or(contains(variables['Build.SourceBranch'], 'epic/'), contains(variables['System.PullRequest.SourceBranch'], 'epic/'))]
  isPullRequest: $[eq(variables['Build.Reason'], 'PullRequest')]

trigger:
  batch: false
  branches:
    include:
      - master
      - develop
      - '*/epic/*'
      - RORDEV*
      - '*/pull/*'
  tags:
    exclude:
      - '*'
  paths:
    include:
      - '*'
    exclude:
      - 'docs/*'
      - '*.md'
      - '*/*/*.md'

parameters:
  - name: preBuildVersionsForPublishingToDockerHub
    type: string
    displayName: 'Space or comma-separated list of ES version numbers (e.g., "7.17.20 8.15.0")'
    default: ' '

pool:
  # we cannot simply bump it to 22.04, because there is a problem (probably) with s3-uploader.sh. Before the next bump
  # attempt, make sure that upload-files-to-s3.sh works.
  vmImage: 'ubuntu-20.04'

variables:
  JAVA_VERSION: '22.0.1'
  JAVA_DIR: 'C:\Java22'

stages:

  - stage: TEST
    displayName: 'Run all tests'
    dependsOn: [ ]
    condition: and(succeeded(), ne(variables['Build.Reason'], 'Manual'))
    jobs:
      - job:
        condition: and(succeeded(), ne(variables.isEpic, true), ne(variables.isDevelop, true), ne(variables.isMaster, true))
        timeoutInMinutes: 120
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - powershell: |
              $jdkVersion = "$(JAVA_VERSION)"
              $installPath = "$(JAVA_DIR)"
              $zipUrl = "https://cdn.azul.com/zulu/bin/zulu$($jdkVersion)-jdk$($jdkVersion)-win_x64.zip"

              Write-Host "Downloading JDK from $zipUrl..."
              Invoke-WebRequest -Uri $zipUrl -OutFile jdk.zip

              Write-Host "Extracting JDK..."
              Expand-Archive jdk.zip -DestinationPath $installPath

              $jdkHome = Get-ChildItem -Directory $installPath | Select-Object -First 1
              $env:JAVA_HOME = $jdkHome.FullName
              $env:Path = "$($env:JAVA_HOME)\bin;$env:Path"

              Write-Host "JAVA_HOME: $env:JAVA_HOME"
              java -version
            displayName: 'Install Java 22 manually'
          - powershell: |
                    Write-Host ">>> $env:ES_MODULE => Running testcontainers.."
                    .\gradlew ror-tools:test "-PesModule=$env:ES_MODULE"
                    if ($LASTEXITCODE -ne 0) {
                      Get-ChildItem -Recurse -Filter *hs_err* | ForEach-Object {
                        Get-Content $_.FullName
                      }
                      exit 1
                    }
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(Windows ES_MODULE) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es90x:
              ES_MODULE: es90x