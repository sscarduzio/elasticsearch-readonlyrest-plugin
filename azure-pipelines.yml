variables:
  ssh_file: '~/.ssh/gh_deploy_key.priv'
  isMaster: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]
  isDevelop: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]
  isPullRequest: $[eq(variables['Build.Reason'], 'PullRequest')]
  isEpicBranchOrPr: $[or(contains(variables['Build.SourceBranch'], 'epic/'), contains(variables['System.PullRequest.SourceBranch'], 'epic/'))]
  isNewEsBranchOrPr: $[or(contains(variables['Build.SourceBranch'], 'newes/'), contains(variables['System.PullRequest.SourceBranch'], 'newes/'))]
  dependencyCheckCacheKey: $[format('dependency-check-v1-{0:yyyyMM}', pipeline.startTime)]
  dependencyCheckDataDir: '$(Pipeline.Workspace)/dependency-check-data/v1'

trigger:
  batch: false
  branches:
    include:
      - master
      - develop
      - '*/epic/*'
      - RORDEV*
      - '*/pull/*'
  tags:
    exclude:
      - '*'
  paths:
    include:
      - '*'
    exclude:
      - 'docs/*'
      - '*.md'
      - '*/*/*.md'

parameters:
  - name: actionToPerform
    type: string
    displayName: '(Manual) action to perform'
    default: 'publish_docker_image_pre_builds'
    values:
      - 'publish_docker_image_pre_builds'
      - 'run_all_tests_on_linux'
      - 'run_all_tests_on_windows'
  - name: preBuildVersionsForPublishingToDockerHub
    type: string
    displayName: 'Space or comma-separated list of ES version numbers (e.g., "7.17.20 8.15.0")'
    default: ' '

pool:
  vmImage: 'ubuntu-24.04'

stages:

  - stage: ES_S3_UP
    displayName: 'Upload missing ROR ES dependencies'
    dependsOn: [ ]
    condition: and(succeeded(), ne(variables['Build.Reason'], 'Manual'), eq(variables.isNewEsBranchOrPr, true))
    jobs:
      - job:
        steps:
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key 
              ci/upload_es_artifacts.sh
            continueOnError: true
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)

  - stage: OPTIONAL_CHECKS
    displayName: 'Optional checks'
    dependsOn: [ ES_S3_UP ]
    condition: and(in(dependencies.ES_S3_UP.result, 'Succeeded', 'Skipped'), ne(variables['Build.Reason'], 'Manual'))
    jobs:
      - job: CVE_CHECK
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - task: Cache@2
            displayName: 'Restore CVE DB from cache'
            inputs:
              key: '$(dependencyCheckCacheKey)'
              # prefix fallback to any prior cache entry
              restoreKeys: dependency-check-v1-
              path: $(dependencyCheckDataDir)
          - script: |
              echo "[OPTIONAL_CHECKS] executing ROR_TASK=$ROR_TASK"

              export DEPENDENCY_CHECK_DATA_DIR=$var_dependency_check_data_dir

              if [ "$var_is_fork" = "False" ]; then
                # Export API key only when PR is from the same repo; forks do not get secrets.
                # Using the wrong API key breaks the CVE check.

                export NVD_API_KEY=$var_nvd_api_key
                export OSS_INDEX_USERNAME=$var_oss_index_username
                export OSS_INDEX_PASSWORD=$var_oss_index_password
              fi

              ci/run-pipeline.sh
            continueOnError: true
            env:
              ROR_TASK: cve_check
              var_nvd_api_key: $(NVD_API_KEY)
              var_dependency_check_data_dir: $(dependencyCheckDataDir)
              var_is_fork: $(System.PullRequest.IsFork)
              var_oss_index_username: $(OSS_INDEX_USERNAME)
              var_oss_index_password: $(OSS_INDEX_PASSWORD)
          - task: Cache@2
            displayName: 'Save updated CVE DB in cache'
            inputs:
              # Cache entries are immutable, a new write will only occur when a new key appears
              key: '$(dependencyCheckCacheKey)'
              path: $(dependencyCheckDataDir)
            condition: succeeded()

  - stage: REQUIRED_CHECKS
    displayName: 'Required checks'
    dependsOn: [ ES_S3_UP ]
    condition: and(in(dependencies.ES_S3_UP.result, 'Succeeded', 'Skipped'), ne(variables['Build.Reason'], 'Manual'))
    jobs:
      - job: 
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              echo "[REQUIRED_CHECKS] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
        strategy:
          maxParallel: 99
          matrix:
            LICENSE_CHECK:
              ROR_TASK: license_check
            COMPILE_CODEBASE_CHECK:
              ROR_TASK: compile_codebase_check
            AUDIT_BUILD_CHECK:
              ROR_TASK: audit_build_check

  - stage: TEST
    displayName: 'Run all tests'
    dependsOn: [ ES_S3_UP ]
    condition:
      and(
        in(dependencies.ES_S3_UP.result, 'Succeeded', 'Skipped'),
        or(
          ne(variables['Build.Reason'], 'Manual'),
          and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests'))
        )
      )
    jobs:
####################################
##### Unit tests
####################################
      - job: UNIT
        condition:
          and(
            succeeded(),
            not(and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_windows')))
          )
        displayName: 'Unit tests'
        timeoutInMinutes: 30
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
              ROR_TASK: core_tests
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true

#######################################################
##### Integration tests for ES 9.x on master/develop
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            or(
              eq(variables.isEpicBranchOrPr, true),
              eq(variables.isDevelop, true),
              eq(variables.isMaster, true),
              and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_linux'))
            )
          )
        container: openjdk:22-jdk-slim
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es92x:
              ROR_TASK: integration_es92x
            IT_es91x:
              ROR_TASK: integration_es91x
            IT_es90x:
              ROR_TASK: integration_es90x

#######################################################
##### Integration tests for ES 8.x on master/develop
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            or(
              eq(variables.isEpicBranchOrPr, true),
              eq(variables.isDevelop, true),
              eq(variables.isMaster, true),
              and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_linux'))
            )
          )
        container: openjdk:22-jdk-slim
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es818x:
              ROR_TASK: integration_es818x
            IT_es816x:
              ROR_TASK: integration_es816x
            IT_es815x:
              ROR_TASK: integration_es815x
            IT_es814x:
              ROR_TASK: integration_es814x
            IT_es813x:
              ROR_TASK: integration_es813x
            IT_es812x:
              ROR_TASK: integration_es812x
            IT_es811x:
              ROR_TASK: integration_es811x
            IT_es810x:
              ROR_TASK: integration_es810x
            IT_es89x:
              ROR_TASK: integration_es89x
            IT_es88x:
              ROR_TASK: integration_es88x
            IT_es87x:
              ROR_TASK: integration_es87x
            IT_es85x:
              ROR_TASK: integration_es85x
            IT_es84x:
              ROR_TASK: integration_es84x
            IT_es83x:
              ROR_TASK: integration_es83x
            IT_es82x:
              ROR_TASK: integration_es82x
            IT_es81x:
              ROR_TASK: integration_es81x
            IT_es80x:
              ROR_TASK: integration_es80x

#######################################################
##### Integration tests for ES <= 7.x on master/develop
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            or(
              eq(variables.isEpicBranchOrPr, true),
              eq(variables.isDevelop, true),
              eq(variables.isMaster, true),
              and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_linux'))
            )
          )
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es717x:
              ROR_TASK: integration_es717x
            IT_es716x:
              ROR_TASK: integration_es716x
            IT_es714x:
              ROR_TASK: integration_es714x
            IT_es711x:
              ROR_TASK: integration_es711x
            IT_es710x:
              ROR_TASK: integration_es710x
            IT_es79x:
              ROR_TASK: integration_es79x
            IT_es78x:
              ROR_TASK: integration_es78x
            IT_es77x:
              ROR_TASK: integration_es77x
            IT_es74x:
              ROR_TASK: integration_es74x
            IT_es73x:
              ROR_TASK: integration_es73x
            IT_es72x:
              ROR_TASK: integration_es72x
            IT_es70x:
              ROR_TASK: integration_es70x
            IT_es67x:
              ROR_TASK: integration_es67x

#######################################################
##### Integration tests for ES 9.x on PRs
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            ne(variables.isEpicBranchOrPr, true),
            ne(variables.isDevelop, true),
            ne(variables.isMaster, true),
            not(and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests')))
          )
        container: openjdk:22-jdk-slim
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es92x:
              ROR_TASK: integration_es92x
            IT_es90x:
              ROR_TASK: integration_es90x

#######################################################
##### Integration tests for ES 8.x on PRs
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            ne(variables.isEpicBranchOrPr, true),
            ne(variables.isDevelop, true),
            ne(variables.isMaster, true),
            not(and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests')))
          )
        container: openjdk:22-jdk-slim
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es818x:
              ROR_TASK: integration_es818x
            IT_es816x:
              ROR_TASK: integration_es816x
            IT_es810x:
              ROR_TASK: integration_es810x
            IT_es80x:
              ROR_TASK: integration_es80x

#######################################################
##### Integration tests for ES <= 7.x on PRs
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            ne(variables.isEpicBranchOrPr, true),
            ne(variables.isDevelop, true),
            ne(variables.isMaster, true),
            not(and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests')))
          )
        timeoutInMinutes: 120
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[TEST] executing ROR_TASK = $ROR_TASK"
              ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(ROR_TASK) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            IT_es717x:
              ROR_TASK: integration_es717x
            IT_es710x:
              ROR_TASK: integration_es710x
            IT_es70x:
              ROR_TASK: integration_es70x
            IT_es67x:
              ROR_TASK: integration_es67x

#######################################################
##### Integration tests on Windows on master/develop
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            or(
              eq(variables.isEpicBranchOrPr, true),
              eq(variables.isDevelop, true),
              eq(variables.isMaster, true)
            ),
            not(and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests')))
          )
        timeoutInMinutes: 150
        pool:
          vmImage: 'windows-2025'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - task: JavaToolInstaller@0
            displayName: Switch to Java 21
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          - powershell: |
              Write-Host ">>> $env:ES_MODULE"
              .\gradlew --no-daemon ror-tools:test integration-tests:test "-PesModule=$env:ES_MODULE"
              if ($LASTEXITCODE -ne 0) {
                Get-ChildItem -Recurse -Filter *hs_err* | ForEach-Object {
                  Get-Content $_.FullName
                }
                exit 1
              }
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(Windows ES_MODULE) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            WIN_IT_es92x:
              ES_MODULE: es92x
            WIN_IT_es90x:
              ES_MODULE: es90x
            WIN_IT_es818x:
              ES_MODULE: es818x
            WIN_IT_es80x:
              ES_MODULE: es80x
            WIN_IT_es717x:
              ES_MODULE: es717x
            WIN_IT_es70x:
              ES_MODULE: es70x

#######################################################
##### Integration tests on Windows on PRs
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            ne(variables.isEpicBranchOrPr, true),
            ne(variables.isDevelop, true),
            ne(variables.isMaster, true),
            not(and(eq(variables['Build.Reason'], 'Manual'), startsWith('${{ parameters.actionToPerform }}', 'run_all_tests')))
          )
        timeoutInMinutes: 150
        pool:
          vmImage: 'windows-2025'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - task: JavaToolInstaller@0
            displayName: Switch to Java 21
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          - powershell: |
                    Write-Host ">>> $env:ES_MODULE"
                    .\gradlew --no-daemon ror-tools:test integration-tests:test "-PesModule=$env:ES_MODULE"
                    if ($LASTEXITCODE -ne 0) {
                      Get-ChildItem -Recurse -Filter *hs_err* | ForEach-Object {
                        Get-Content $_.FullName
                      }
                      exit 1
                    }
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(Windows ES_MODULE) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            WIN_IT_es92x:
              ES_MODULE: es92x
            WIN_IT_es818x:
              ES_MODULE: es818x
            WIN_IT_es717x:
              ES_MODULE: es717x

#######################################################
##### Integration tests on Windows for manual job 'run_all_tests_on_windows'
#######################################################
      - job:
        condition:
          and(
            succeeded(),
            and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_windows'))
          )
        timeoutInMinutes: 150
        pool:
          vmImage: 'windows-2025'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - task: JavaToolInstaller@0
            displayName: Switch to Java 21
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          - powershell: |
                    Write-Host ">>> $env:ES_MODULE"
                    .\gradlew --no-daemon ror-tools:test integration-tests:test "-PesModule=$env:ES_MODULE"
                    if ($LASTEXITCODE -ne 0) {
                      Get-ChildItem -Recurse -Filter *hs_err* | ForEach-Object {
                        Get-Content $_.FullName
                      }
                      exit 1
                    }
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(Windows ES_MODULE) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true
        strategy:
          maxParallel: 99
          matrix:
            WIN_IT_es92x:
              ES_MODULE: es92x
            WIN_IT_es91x:
              ES_MODULE: es91x
            WIN_IT_es90x:
              ES_MODULE: es90x
            WIN_IT_es818x:
              ES_MODULE: es818x
            WIN_IT_es816x:
              ES_MODULE: es816x
            WIN_IT_es815x:
              ES_MODULE: es815x
            WIN_IT_es814x:
              ES_MODULE: es814x
            WIN_IT_es813x:
              ES_MODULE: es813x
            WIN_IT_es812x:
              ES_MODULE: es812x
            WIN_IT_es811x:
              ES_MODULE: es811x
            WIN_IT_es810x:
              ES_MODULE: es810x
            WIN_IT_es89x:
              ES_MODULE: es89x
            WIN_IT_es88x:
              ES_MODULE: es88x
            WIN_IT_es87x:
              ES_MODULE: es87x
            WIN_IT_es85x:
              ES_MODULE: es85x
            WIN_IT_es84x:
              ES_MODULE: es84x
            WIN_IT_es83x:
              ES_MODULE: es83x
            WIN_IT_es82x:
              ES_MODULE: es82x
            WIN_IT_es81x:
              ES_MODULE: es81x
            WIN_IT_es80x:
              ES_MODULE: es80x
            WIN_IT_es717x:
              ES_MODULE: es717x
            WIN_IT_es716x:
              ES_MODULE: es716x
            WIN_IT_es714x:
              ES_MODULE: es714x
            WIN_IT_es711x:
              ES_MODULE: es711x
            WIN_IT_es710x:
              ES_MODULE: es710x
            WIN_IT_es79x:
              ES_MODULE: es79x
            WIN_IT_es78x:
              ES_MODULE: es78x
            WIN_IT_es77x:
              ES_MODULE: es77x
            WIN_IT_es74x:
              ES_MODULE: es74x
            WIN_IT_es73x:
              ES_MODULE: es73x
            WIN_IT_es72x:
              ES_MODULE: es72x
            WIN_IT_es70x:
              ES_MODULE: es70x

####################################
##### Unit tests on Windows
####################################
      - job:
        displayName: 'Unit tests on Windows'
        condition:
          and(
            succeeded(),
            and(eq(variables['Build.Reason'], 'Manual'), eq('${{ parameters.actionToPerform }}', 'run_all_tests_on_windows'))
          )
        timeoutInMinutes: 150
        pool:
          vmImage: 'windows-2025'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - task: JavaToolInstaller@0
            displayName: Switch to Java 21
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          - powershell: |
                    Write-Host ">>> $env:ES_MODULE"
                    .\gradlew --no-daemon core:test
                    if ($LASTEXITCODE -ne 0) {
                      Get-ChildItem -Recurse -Filter *hs_err* | ForEach-Object {
                        Get-Content $_.FullName
                      }
                      exit 1
                    }
          - task: PublishTestResults@2
            condition: failed()
            inputs:
              testRunTitle: "$(Windows core) results"
              testResultsFiles: "**/TEST*xml"
              mergeTestResults: true


  - stage: BUILD_ROR
    displayName: 'Build ROR plugins'
    dependsOn:
      - REQUIRED_CHECKS
      - TEST
    condition: |
      and(
        succeeded(), 
        succeeded('REQUIRED_CHECKS'),
        succeeded('TEST'),
        eq(variables.isPullRequest, true),
        ne(variables['Build.Reason'], 'Manual')
      )
    jobs:
      - job:
        timeoutInMinutes: 180
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false

          - script: |
              set -e

              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[BUILD_ROR] executing ROR_TASK = $ROR_TASK"
              echo ">>> ($ROR_TASK) Building ROR plugins" && ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)

        strategy:
          maxParallel: 99
          matrix:
            BUILD_9xx:
              ROR_TASK: build_es9xx
            BUILD_8xx:
              ROR_TASK: build_es8xx
            BUILD_7xx:
              ROR_TASK: build_es7xx
            BUILD_6xx:
              ROR_TASK: build_es6xx

  - stage: DETERMINE_CI_TYPE
    displayName: 'Determine if this is release run'
    dependsOn:
      - REQUIRED_CHECKS
      - TEST
    condition: |
      and(
        succeeded(), 
        succeeded('REQUIRED_CHECKS'),
        succeeded('TEST'),
        or(eq(variables.isDevelop, true), eq(variables.isMaster, true)),
        ne(variables['Build.Reason'], 'Manual')
      )
    jobs:
      - job: EXTRACT_IS_RELEASE
        steps:
          - bash: |
              IS_RELEASE=true
              if grep '^pluginVersion=' gradle.properties | awk -F= '{print $2}' | grep "\-pre"; then
                IS_RELEASE=false
              fi
              echo "##vso[task.setvariable variable=value;isOutput=true]$IS_RELEASE"
            name: IsRelease

  - stage: UPLOAD_PRE_ROR
    displayName: 'Upload to S3 ROR plugin pre-builds'
    dependsOn:
      - DETERMINE_CI_TYPE
      - REQUIRED_CHECKS
      - TEST
    condition: |
      and(
        succeeded(),
        succeeded('REQUIRED_CHECKS'),
        succeeded('TEST'),
        or(eq(variables.isDevelop, true), eq(variables.isMaster, true)),
        eq(dependencies.DETERMINE_CI_TYPE.outputs['EXTRACT_IS_RELEASE.IsRelease.value'], false),
        ne(variables['Build.Reason'], 'Manual')
      )
    jobs:
      - job:
        timeoutInMinutes: 600
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true

          - script: |
              set -e

              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              echo "[UPLOAD_PRE_ROR] executing ROR_TASK = $ROR_TASK"
              echo ">>> ($ROR_TASK) Uploading pre-ROR" && ci/run-pipeline.sh
            timeoutInMinutes: 600
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)

        strategy:
          maxParallel: 99
          matrix:
            UPLOAD_PRE_9xx:
              ROR_TASK: upload_pre_es9xx
            UPLOAD_PRE_8xx:
              ROR_TASK: upload_pre_es8xx
            UPLOAD_PRE_7xx:
              ROR_TASK: upload_pre_es7xx
            UPLOAD_PRE_6xx:
              ROR_TASK: upload_pre_es6xx

  - stage: RELEASE_ROR
    displayName: 'Release ROR plugins'
    dependsOn:
      - DETERMINE_CI_TYPE
      - REQUIRED_CHECKS
      - TEST
    condition: |
      and(
        succeeded(),
        succeeded('REQUIRED_CHECKS'),
        succeeded('TEST'),
        or(eq(variables.isDevelop, true), eq(variables.isMaster, true)),
        eq(dependencies.DETERMINE_CI_TYPE.outputs['EXTRACT_IS_RELEASE.IsRelease.value'], true),
        ne(variables['Build.Reason'], 'Manual')
      )
    jobs:
      - job:
        timeoutInMinutes: 180
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
            timeoutInMinutes: 180

          - script: |
              set -e

              echo ">>>> Installing dependencies with apt-get"
              sudo apt-get update && sudo apt-get install -y git file
              git status && echo ">>> Git installed correctly!"

              # Translate back env vars to avoid cyclical reference :/
              export aws_access_key_id=$var_aws_access_key_id
              export aws_secret_access_key=$var_aws_secret_access_key

              export DOCKER=docker
              if ! docker login -u $var_docker_registry_user -p $var_docker_registry_password; then
                echo "Error: Failed to login to Docker registry"
                exit 1
              fi

              echo "[RELEASE_ROR] executing ROR_TASK = $ROR_TASK"
              echo ">>> ($ROR_TASK) Releasing ROR" && ci/run-pipeline.sh
            env:
              var_aws_access_key_id: $(aws_access_key_id)
              var_aws_secret_access_key: $(aws_secret_access_key)
              var_docker_registry_user: $(DOCKER_REGISTRY_USER)
              var_docker_registry_password: $(DOCKER_REGISTRY_PASSWORD)

        strategy:
          maxParallel: 99
          matrix:
            RELEASE_ES_9xx:
              ROR_TASK: release_es9xx
            RELEASE_ES_8xx:
              ROR_TASK: release_es8xx
            RELEASE_ES_7xx:
              ROR_TASK: release_es7xx
            RELEASE_ES_6xx:
              ROR_TASK: release_es6xx

  - stage: PUBLISH_MVN_ARTIFACTS
    displayName: 'Publish Maven artifacts'
    dependsOn:
      - DETERMINE_CI_TYPE
      - REQUIRED_CHECKS
      - TEST
    condition: |
      and(
        succeeded(),
        succeeded('REQUIRED_CHECKS'),
        succeeded('TEST'),
        eq(variables.isMaster, true),
        eq(dependencies.DETERMINE_CI_TYPE.outputs['EXTRACT_IS_RELEASE.IsRelease.value'], true),
        ne(variables['Build.Reason'], 'Manual')
      )
    jobs:
      - job:
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true

          # Populate the global variable mvn_status for later
          - script: |
              PLUGIN_VER=$(awk -F= '$1=="pluginVersion" {print $2}' gradle.properties)
              URL="https://oss.sonatype.org/service/local/repositories/releases/content/tech/beshu/ror/audit_2.12/$PLUGIN_VER/"
              echo "Maven artifact URL to check: $URL"
              MVN_STATUS=$(curl --write-out '%{http_code}' --output /dev/null "$URL")
              echo "##vso[task.setvariable variable=mvn_status]$MVN_STATUS"

          - script: |
              echo ">> MVN_STATUS WAS 200. Artifact already present, no need to proceed further with Maven publishing."
            condition: eq(200, variables.mvn_status)

          - script: |
              echo ">> MVN_STATUS WAS 404. Artifact not present in Maven repository, proceeding with publishing."
            condition: eq(404, variables.mvn_status)

          - task: DownloadSecureFile@1
            name: pgp
            displayName: 'Download secret.pgp secret file'
            inputs:
              secureFile: 'secret.pgp'

          - script: |
              echo Installing $(pgp.secureFilePath) to directory...
              sudo chown root:root $(pgp.secureFilePath)
              sudo chmod a+r $(pgp.secureFilePath)
              mkdir .travis
              sudo ln -s -t .travis/ $(pgp.secureFilePath)
              echo "secret.pgp MD5SUSM `md5sum .travis/secret.pgp`"
            condition: eq(404, variables.mvn_status)

          - script: |
              echo "[MVN_PUBLISH] executing ROR_TASK=$ROR_TASK"
              export MAVEN_REPO_PASSWORD=$VAR_MAVEN_REPO_PASSWORD
              export MAVEN_REPO_USER=$VAR_MAVEN_REPO_USER
              export MAVEN_STAGING_PROFILE_ID=$VAR_MAVEN_STAGING_PROFILE_ID
              export GPG_KEY_ID=$VAR_GPG_KEY_ID
              export GPG_PASSPHRASE=$VAR_GPG_PASSPHRASE
              echo ">>> ($ROR_TASK) Publishing MVN artifacts" && ci/run-pipeline.sh
            env:
              ROR_TASK: publish_maven_artifacts
              VAR_MAVEN_REPO_PASSWORD: $(MAVEN_REPO_PASSWORD)
              VAR_MAVEN_REPO_USER: $(MAVEN_REPO_USER)
              VAR_MAVEN_STAGING_PROFILE_ID: $(MAVEN_STAGING_PROFILE_ID)
              VAR_GPG_PASSPHRASE: $(GPG_PASSPHRASE)
              VAR_GPG_KEY_ID: $(GPG_KEY_ID)
            condition: eq(404, variables.mvn_status)

  - stage: PRE_BUILDS_DOCKER_IMAGE_PUBLISHING
    displayName: 'Publish docker images for specified pre-builds'
    dependsOn: [ ]
    condition:
      and(
        succeeded(),
        eq(variables['Build.Reason'], 'Manual'),
        eq('${{ parameters.actionToPerform }}', 'publish_docker_image_pre_builds')
      )
    jobs:
      - job: PUBLISH
        displayName: 'Publishing'
        timeoutInMinutes: "600"
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false
            persistCredentials: true
          - script: |
              set -ex

              export DOCKER=docker
              docker login -u $var_docker_registry_user -p $var_docker_registry_password
              if ! docker login -u $var_docker_registry_user -p $var_docker_registry_password; then
                echo "Error: Failed to login to Docker registry"
                exit 1
              fi

              export BUILD_ROR_ES_VERSIONS="${{ parameters.preBuildVersionsForPublishingToDockerHub }}"

              if [ -z "$(echo "$BUILD_ROR_ES_VERSIONS" | tr -d '[:space:],')" ]; then
                echo "Error: No ES versions specified for publishing ROR pre-builds"
                exit 1
              fi

              echo "[RELEASE_ROR] executing ROR_TASK = $ROR_TASK"
              echo ">>> ($ROR_TASK) Publish docker images for specified pre-builds" && ci/run-pipeline.sh
            timeoutInMinutes: "600"
            condition: succeeded()
            env:
              ROR_TASK: publish_pre_builds_docker_images
              var_docker_registry_user: $(DOCKER_REGISTRY_USER)
              var_docker_registry_password: $(DOCKER_REGISTRY_PASSWORD)
